name: CI Build Final Debug (force build from myapp-cd)

on:
  workflow_dispatch:
  push:
    branches: [ main ]

permissions:
  contents: write

env:
  IMAGE_NAME: myapp
  REGISTRY: docker.io

jobs:
  build-and-update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo (full)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Show git commit + remote tree (debug)
        run: |
          echo "GIT remote:"
          git remote -v
          echo "Current commit:"
          git rev-parse HEAD
          echo "Files at root (ls -la):"
          ls -la
          echo "List repo tree (top-level):"
          git ls-tree -r --name-only HEAD | sed -n '1,200p'
          echo "--- show myapp-cd/Dockerfile exists? ---"
          if [ -f myapp-cd/Dockerfile ]; then echo "FOUND myapp-cd/Dockerfile"; else echo "NOT FOUND myapp-cd/Dockerfile"; fi

      - name: Show Dockerfile content + checksum (debug)
        run: |
          echo "---- stat myapp-cd/Dockerfile ----"
          stat myapp-cd/Dockerfile || true
          echo "---- head of myapp-cd/Dockerfile ----"
          sed -n '1,120p' myapp-cd/Dockerfile || echo "no myapp-cd/Dockerfile"
          echo "---- sha256sum ----"
          sha256sum myapp-cd/Dockerfile || true

      - name: Quick secret sanity check
        env:
          DH_USER: ${{ secrets.DOCKERHUB_USERNAME }}
          DH_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
        run: |
          if [ -z "${DH_USER:-}" ] || [ -z "${DH_TOKEN:-}" ]; then
            echo "::error ::DOCKERHUB_USERNAME & DOCKERHUB_TOKEN missing"
            exit 2
          fi
          echo "Secrets present (lengths): user=${#DH_USER}, token=${#DH_TOKEN}"

      - name: Docker login (use token)
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build FROM myapp-cd (explicit cd then build)
        env:
          IMAGE_FULL: ${{ env.REGISTRY }}/${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
        run: |
          set -euo pipefail
          echo "PWD pre-build: $(pwd)"
          echo "Switching into myapp-cd and building explicitly"
          cd myapp-cd
          echo "PWD now: $(pwd)"
          echo "Listing myapp-cd contents:"
          ls -la
          echo "Show Dockerfile head:"
          sed -n '1,80p' Dockerfile || true
          echo "sha256sum Dockerfile:"
          sha256sum Dockerfile || true
          echo "Running docker build command:"
          docker build -f Dockerfile -t "$IMAGE_FULL" . 2>&1 | sed -n '1,400p' || true
          echo "After build, list images filter:"
          docker images --format '{{.Repository}}:{{.Tag}}' | sed -n '1,200p' || true
          if docker images --format '{{.Repository}}:{{.Tag}}' | grep -q "$IMAGE_FULL"; then
            echo "Image built, pushing..."
            docker push "$IMAGE_FULL" 2>&1 | sed -n '1,200p' || true
            echo "Push finished"
          else
            echo "::error ::Image $IMAGE_FULL not present after build"
            exit 1
          fi

      - name: Done
        run: echo "CI finished."
